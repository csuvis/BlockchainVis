d3.sankey=function(){function n(){g.forEach(function(n){n.sourceLinks=[],n.targetLinks=[]}),h.forEach(function(n){var r=n.source,t=n.target;"number"==typeof r&&(r=n.source=g[n.source]),"number"==typeof t&&(t=n.target=g[n.target]),r.sourceLinks.push(n),t.targetLinks.push(n)})}function r(){g.forEach(function(n){n.value=Math.max(d3.sum(n.sourceLinks,f),d3.sum(n.targetLinks,f))})}function t(){for(var n,r=g,t=0;r.length;)n=[],r.forEach(function(r){r.x=t,r.dx=s,r.sourceLinks.forEach(function(r){n.indexOf(r.target)<0&&n.push(r.target)})}),r=n,++t;u(t),e((d[0]-s)/(t-1))}function u(n){g.forEach(function(r){r.sourceLinks.length||(r.x=n-1)})}function e(n){g.forEach(function(r){r.x*=n})}function o(n){function r(){var n=d3.min(c,function(n){return(d[1]-(n.length-1)*y)/d3.sum(n,f)});c.forEach(function(r){r.forEach(function(r,t){r.y=t,r.dy=r.value*n})}),h.forEach(function(r){r.dy=r.value*n})}function t(n){function r(n){return i(n.source)*n.value}c.forEach(function(t,u){t.forEach(function(t){if(t.targetLinks.length){var u=d3.sum(t.targetLinks,r)/d3.sum(t.targetLinks,f);t.y+=(u-i(t))*n}})})}function u(n){function r(n){return i(n.target)*n.value}c.slice().reverse().forEach(function(t){t.forEach(function(t){if(t.sourceLinks.length){var u=d3.sum(t.sourceLinks,r)/d3.sum(t.sourceLinks,f);t.y+=(u-i(t))*n}})})}function e(){c.forEach(function(n){var r,t,u,e=0,c=n.length;for(n.sort(o),u=0;u<c;++u)r=n[u],t=e-r.y,t>0&&(r.y+=t),e=r.y+r.dy+y;if(t=e-y-d[1],t>0)for(e=r.y-=t,u=c-2;u>=0;--u)r=n[u],t=r.y+r.dy+y-e,t>0&&(r.y-=t),e=r.y})}function o(n,r){return n.y-r.y}var c=d3.nest().key(function(n){return n.x}).sortKeys(d3.ascending).entries(g).map(function(n){return n.values});r(),e();for(var a=1;n>0;--n)u(a*=.99),e(),t(a),e()}function c(){function n(n,r){return n.source.y-r.source.y}function r(n,r){return n.target.y-r.target.y}g.forEach(function(t){t.sourceLinks.sort(r),t.targetLinks.sort(n)}),g.forEach(function(n){var r=0,t=0;n.sourceLinks.forEach(function(n){n.sy=r,r+=n.dy}),n.targetLinks.forEach(function(n){n.ty=t,t+=n.dy})})}function i(n){return n.y+n.dy/2}function f(n){return n.value}var a={},s=24,y=8,d=[1,1],g=[],h=[];return a.nodeWidth=function(n){return arguments.length?(s=+n,a):s},a.nodePadding=function(n){return arguments.length?(y=+n,a):y},a.nodes=function(n){return arguments.length?(g=n,a):g},a.links=function(n){return arguments.length?(h=n,a):h},a.size=function(n){return arguments.length?(d=n,a):d},a.layout=function(u){return n(),r(),t(),o(u),c(),a},a.relayout=function(){return c(),a},a.link=function(){function n(n){var t=n.source.x+n.source.dx,u=n.target.x,e=d3.interpolateNumber(t,u),o=e(r),c=e(1-r),i=n.source.y+n.sy+n.dy/2,f=n.target.y+n.ty+n.dy/2;return"M"+t+","+i+"C"+o+","+i+" "+c+","+f+" "+u+","+f}var r=.5;return n.curvature=function(t){return arguments.length?(r=+t,n):r},n},a.link_in=function(){function n(n){if(n.source.showdot)return"";var t=n.source.x+n.source.dx,u=n.tx2,e=d3.interpolateNumber(t,u),o=e(r),c=e(1-r),i=n.source.y,f=i+n.dy,a=n.ty2,s=a+n.dy2;return"M"+t+","+i+"C"+o+","+i+" "+c+","+a+" "+u+","+a+"L"+u+","+s+"C"+c+","+s+" "+o+","+f+" "+t+","+f+"L"+t+","+i}var r=.5;return n.curvature=function(t){return arguments.length?(r=+t,n):r},n},a.link_in_line=function(){function n(n){if(n.source.showdot)return"";var r=n.source.x+n.source.dx,t=n.tx2,u=n.source.y,e=u+n.dy,o=n.ty2,c=o+n.dy2;return"M"+r+","+u+"L"+t+","+o+"L"+t+","+c+"L"+r+","+e+"L"+r+","+u}return n.curvature=function(r){return arguments.length?(curvature=+r,n):curvature},n},a.link_in_last=function(n){function r(n){var r=n.source.x+n.source.dx,u=n.tx2,e=d3.interpolateNumber(r,u),o=e(t),c=e(1-t),i=n.source.y,f=i+n.source.dy,a=n.ty2,s=a+n.dy2;return"M"+r+","+i+"C"+o+","+i+" "+c+","+a+" "+u+","+a+"L"+u+","+s+"C"+c+","+s+" "+o+","+f+" "+r+","+f+"a"+.5*n.source.dy+","+.5*n.source.dy+" 0 1,0 0,"+-n.source.dy}var t=.5;return r.curvature=function(n){return arguments.length?(t=+n,r):t},r},a.link_out=function(){function n(n){var t=n.sx2,u=n.target.x,e=d3.interpolateNumber(t,u),o=e(r),c=e(1-r),i=n.sy2,f=i+n.dy2,a=n.target.y,s=a+n.target.dy;return"M"+t+","+i+"C"+o+","+i+" "+c+","+a+" "+u+","+a+"L"+u+","+s+"C"+c+","+s+" "+o+","+f+" "+t+","+f+"L"+t+","+i}var r=.5;return n.curvature=function(t){return arguments.length?(r=+t,n):r},n},a.link_out_line=function(){function n(n){var r=n.sx2,t=n.target.x,u=n.sy2,e=u+n.dy2,o=n.target.y,c=o+n.target.dy;return"M"+r+","+u+"L"+t+","+o+"L"+t+","+c+"L"+r+","+e+"L"+r+","+u}return n.curvature=function(r){return arguments.length?(curvature=+r,n):curvature},n},a};